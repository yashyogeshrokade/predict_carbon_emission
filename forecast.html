<script>
  const API_URL = "https://energy-backend-ie4o.onrender.com/predict";
  const params = new URLSearchParams(window.location.search);
  const building = params.get('building') || '';
  document.getElementById('buildingTitle').innerText = building ? `${building} — Forecast` : 'Forecast';

  function goBack() {
    window.location.href = 'details.html' + (building ? `?building=${encodeURIComponent(building)}` : '');
  }

  const normalize = str => str.toLowerCase().replace(/[\s\-\(\)]/g, '');

  document.getElementById('forecastForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const temperature = parseFloat(document.getElementById('temperature').value);
    const humidity = parseFloat(document.getElementById('humidity').value);
    const month = document.getElementById('month').value;

    const payload = { building, temperature, humidity, month };

    document.getElementById('result').innerText = "Predicting...";
    document.getElementById('carbonResult').innerText = "";

    try {
      const res = await fetch(API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      const data = await res.json();
      if (data.success) {
        const predictedEnergy = parseFloat(data.predicted_energy);
        document.getElementById('result').innerText =
          `Predicted Energy Consumption: ${predictedEnergy.toFixed(2)} kWh`;
        computeCarbonEmission(building, predictedEnergy);
      } else {
        document.getElementById('result').innerText = 'Error: ' + data.error;
      }
    } catch (err) {
      document.getElementById('result').innerText = 'Network Error: ' + err.message;
    }
  });

  async function computeCarbonEmission(buildingName, predictedEnergy) {
    try {
      const response = await fetch('Energy_2.xlsx');
      const arrayBuffer = await response.arrayBuffer();
      const workbook = XLSX.read(arrayBuffer, { type: 'array' });
      const sheet = workbook.Sheets[workbook.SheetNames[0]];
      const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1 });
      const rows = jsonData.slice(2);

      const target = normalize(buildingName);
      const buildingRow = rows.find(row => normalize(row[1]) === target);
      if (!buildingRow) {
        document.getElementById('carbonResult').innerText = "⚠ Building not found in Excel.";
        return;
      }

      const numAC = Number(buildingRow[15]) || 0;
      const totalEnergy = Number(buildingRow[14]) || predictedEnergy;

      const refrigerantPerAC = 2.0;
      const leakageRate = 0.10;
      const GWP = 2088;
      const gridFactor = 0.75;

      const totalRefrigerant = numAC * refrigerantPerAC;
      const annualLeakage = totalRefrigerant * leakageRate;
      const shareOfYear = predictedEnergy / totalEnergy;
      const monthlyLeakage = annualLeakage * shareOfYear;
      const refrigerantCO2 = monthlyLeakage * GWP;
      const electricityCO2 = predictedEnergy * gridFactor;
      const totalCO2 = refrigerantCO2 + electricityCO2;

      document.getElementById('carbonResult').innerHTML =
        `<strong>Estimated Carbon Emission:</strong> ${totalCO2.toLocaleString(undefined, { maximumFractionDigits: 2 })} kg CO₂<br>
         <strong>No. of AC Units:</strong> ${numAC}`;
    } catch (err) {
      document.getElementById('carbonResult').innerText = "⚠ Error reading Excel: " + err.message;
    }
  }
</script>
