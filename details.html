<script>
  function goBack() {
    window.location.href = 'index.html';
  }

  function goToForecast() {
    const urlParams = new URLSearchParams(window.location.search);
    const building = urlParams.get('building');
    const url = `forecast.html?building=${encodeURIComponent(building)}`;
    window.location.href = url;
  }

  const urlParams = new URLSearchParams(window.location.search);
  const buildingName = urlParams.get('building');
  const months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep"];

  if (buildingName) {
    document.getElementById("energyTitle").innerText = `${buildingName} - Energy Consumption`;
    document.getElementById("carbonTitle").innerText = `${buildingName} - Carbon Emission`;
  }

  const normalize = str => str.toLowerCase().replace(/[\s\-\(\)]/g, '');

  // === Load data from Energy_2.xlsx ===
  fetch('Energy_2.xlsx')
    .then(response => response.arrayBuffer())
    .then(data => {
      const workbook = XLSX.read(data, { type: 'array' });
      const sheet = workbook.Sheets[workbook.SheetNames[0]];
      const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1 });

      // Data starts from row 3
      const rows = jsonData.slice(2);
      const target = normalize(buildingName);
      const buildingRow = rows.find(row => normalize(row[1]) === target);

      if (!buildingRow) {
        alert("Building not found in Excel!");
        return;
      }

      // Energy columns: C–K = indices 2–10
      const energyValues = buildingRow.slice(2, 11).map(Number);
      const totalEnergy = Number(buildingRow[14]) || energyValues.reduce((a, b) => a + (b || 0), 0);
      const numAC = Number(buildingRow[15]) || 0;

      // === Energy Chart ===
      const ctxEnergy = document.getElementById('energyChart').getContext('2d');
      new Chart(ctxEnergy, {
        type: 'bar',
        data: {
          labels: months,
          datasets: [{
            label: 'Energy Consumption (kWh)',
            data: energyValues,
            backgroundColor: '#ef4444',
            borderColor: '#991b1b',
            borderWidth: 1,
            borderRadius: 6
          }]
        },
        options: {
          scales: { y: { beginAtZero: true } },
          plugins: {
            legend: { display: false },
            title: { display: true, text: 'Monthly Energy Consumption (kWh)', font: { size: 16 } }
          }
        }
      });

      document.getElementById('energyInfo').innerHTML =
        `<strong>Total Energy:</strong> ${totalEnergy.toLocaleString()} kWh<br>
         <strong>No. of AC Units:</strong> ${numAC}`;

      // === Carbon Emission Calculation ===
      const refrigerantPerAC = 2.0;
      const leakageRate = 0.10;
      const GWP = 2088;
      const gridFactor = 0.75;

      const totalRefrigerant = numAC * refrigerantPerAC;
      const annualLeakage = totalRefrigerant * leakageRate;

      const carbonValues = energyValues.map(e => {
        const shareOfYear = e / totalEnergy;
        const monthlyLeakage = annualLeakage * shareOfYear;
        const refrigerantCO2 = monthlyLeakage * GWP;
        const electricityCO2 = e * gridFactor;
        return refrigerantCO2 + electricityCO2;
      });

      const totalCarbon = carbonValues.reduce((a, b) => a + b, 0);

      // === Carbon Chart ===
      const ctxCarbon = document.getElementById('carbonChart').getContext('2d');
      new Chart(ctxCarbon, {
        type: 'bar',
        data: {
          labels: months,
          datasets: [{
            label: 'Carbon Emission (kg CO₂)',
            data: carbonValues,
            backgroundColor: '#10b981',
            borderColor: '#065f46',
            borderWidth: 1,
            borderRadius: 6
          }]
        },
        options: {
          scales: { y: { beginAtZero: true } },
          plugins: {
            legend: { display: false },
            title: { display: true, text: 'Monthly Carbon Emission (kg CO₂)', font: { size: 16 } }
          }
        }
      });

      document.getElementById('carbonInfo').innerHTML =
        `<strong>Total Carbon Emission:</strong> ${totalCarbon.toLocaleString(undefined, { maximumFractionDigits: 2 })} kg CO₂`;
    });
</script>

